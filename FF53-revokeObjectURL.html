<!doctype html>
	<meta charset=utf-8>
	<title>Firefox53 img.src=blob bugtest</title>

	<!-- ======================================================================================= -->
	<!--                                                                                         -->
	<!-- in SHRINK-AND-SMOOTH.HTML:                                                              -->
	<!-- when FIREFOX 53 inserts an IMG with SRC=BLOB into DOM, it causes IMG.ONERROR to fire.   -->
	<!--                                                                                         -->
	<!-- after some study, it is traced down to this:                                            -->
	<!-- during IMG.ONLOAD this is executed.                                                     -->
	<!--                                                                                         -->
	<!--     URL.revokeObjectURL(img.src)                                                        -->
	<!--                                                                                         -->
	<!-- thereafter, when the IMG is inserted into DOM, it renders fine.  But it fires ONERROR.  -->
	<!--                                                                                         -->
	<!-- ======================================================================================= -->

	<style>
		* { font-family:'Segoe UI',sans-serif; font-size:12pt }
		#btn { margin:1em 2em 1em 0 }
		::-moz-focus-inner { border:0; padding:0 }
	</style>

	<script>
		onload= function(){
			onload= function(){
				var imgstring= '<img id=img src=$1 onload="$2" onerror="$3" style=display:none>'
						.replace("$1", URL.createObjectURL( xhr.response ))
						.replace("$2",[	"window[id]=this",
								"var w=Math.min(400,naturalWidth)",
								"var h=naturalHeight*w/naturalWidth||0",
								"imgdiv.style.cssText='width:'+w+'px; height:'+h+'px; border:1px solid black'",
								"style.cssText='width:100%; height:100%; display:block'",
								"btn.hidden=btn2.hidden=false",
								"btn2.disabled= src[0]=='b'?false:true",
								"btn2.textContent='revoke blob'"
								].join("\n"))
						.replace("$3","document.body.insertAdjacentHTML('beforeend','<br>'+event.timeStamp+' &bull; '+event.type)")

				imgdiv.insertAdjacentHTML("afterbegin", imgstring)
			}
		}
		try{	var xhr= new XMLHttpRequest()
			xhr.open("GET","firefox_logo-only_RGB.png",true)
			xhr.responseType="blob"
			xhr.onload= function(){onload()}
			xhr.onerror= function(evt){ onload( xhr={response:new Blob([""])} )}			// CHROME refuses to xhr a local-desktop file.  fires ONERROR.
			xhr.send()
		}catch(e){ onload( xhr={response:new Blob([""])} )}						// IE refuses to xhr a local-desktop file.  THROWS.


		document.ondragenter=
		document.ondragover=
			function(evt){
				evt.stopPropagation && evt.stopPropagation()
				evt.preventDefault && evt.preventDefault()
				return ( evt.returnValue= false )
			}
		document.ondrop=
			function(evt){
				this.ondragover(evt)

				var dt= evt.dataTransfer, dropfile
				if (!dt) return false

				if (window.URL && dt.files && dt.files[0]){

					if ( (/^image\//i).test(dt.files[0].type) ){
						dropfile= URL.createObjectURL(dt.files[0])
						img.removeAttribute("crossOrigin")
					}
				}else{
					try{	dropfile=/*encodeURI*/(	(dt.getData('URL')        ||			// hmm. percent-encode it ?
									 dt.getData('text')       ||
									 dt.getData('text/plain') ||			// IE throws on "text/plain"
									 "").match(/^https?:\/\/\S+|^file:\S+/i)
									)
						img.crossOrigin="anonymous"
					}catch(e){/*( IE throws on text/plain )*/}
				}
				if (!dropfile) return false

				try{ img.src= dropfile; img.style.display="none" }		// FIREFOX throws here if it's CORS "tainted", without indicating any reason why.  Just Event type=error.  humph.
				catch(e){ img.onerror( {type:e, timeStamp:Date.now()} )}

				return false
			}
	</script>

	<div id=imgdiv>
	</div>

	<button	id=btn hidden
		onclick="if (this.textContent=='remove img'){
				imgdiv.innerHTML=''
				this.textContent='insert img'
			}else{
				imgdiv.appendChild(window.img)		// Chrome does **NOT need window.prefix here
				this.textContent='remove img'
			}"
			>remove img</button>

	<button	id=btn2 hidden
		onclick="window.URL.revokeObjectURL(window.img.src)	// need window.img prefix on img for Chrome**
			this.disabled=true				// need this. prefix for IE
			this.textContent='revoked'"
			>
			revoke blob</button>